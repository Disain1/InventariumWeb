<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        td[contenteditable="true"]:focus {
            background-color: #e6f7ff;
            outline: 2px solid #66afe9;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-5">
    <div class="container-fluid mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>–î–∞–Ω–Ω—ã–µ Inventarium</h1>
            
            <div>
                <form action="/import_excel" method="post" enctype="multipart/form-data" class="d-inline">
                    <input type="file" name="file" accept=".xlsx" class="form-control d-inline w-auto" required>
                    <button type="submit" class="btn btn-primary">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç –∏–∑ Excel</button>
                </form>
    
                <a href="/export_excel" class="btn btn-success">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
            </div>
        </div>

    
    <div class="py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h3>–°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStorageModal">–î–æ–±–∞–≤–∏—Ç—å —Å–∫–ª–∞–¥</button>
        </div>
        <input type="text" class="form-control" id="searchStorages" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥–∞–º...">
    </div>
    <table class="table table-striped table-bordered" id="editableStoragesTable">
        <thead class="table-dark">
            <tr>
                <th></th>
                <th>–§–æ—Ç–æ</th>
                <th onclick="toggleSort(this, 'editableStoragesTable', 2)">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ <span></span></th>
                <th onclick="toggleSort(this, 'editableStoragesTable', 3)">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ <span></span></th>
                <th onclick="toggleSort(this, 'editableStoragesTable', 4)">–ê–¥—Ä–µ—Å <span></span></th>
                <th onclick="toggleSort(this, 'editableStoragesTable', 5)">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) <span></span></th>
            </tr>
        </thead>
        <tbody>
        {% for storage in storages %}
            <tr data-doc-id="{{ storage.id }}">
                <td>
                    <button class="btn btn-danger btn-sm delete-button"
                        data-doc-id="{{ storage.id }}"
                        data-collection="storages"
                        data-name="{{ storage.name }}">üóë</button>
                </td>


                <td>
                    {% if storage.photoUrl %}
                        <img src="{{ storage.photoUrl }}" alt="–§–æ—Ç–æ" 
                                class="img-thumbnail clickable-photo" 
                                style="max-height: 100px; max-width: 100px; object-fit: cover;">
                    {% else %}
                        <span class="text-muted">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                    {% endif %}
                </td>
                <td contenteditable="true" data-field="name">{{ storage.name }}</td>
                <td contenteditable="true" data-field="note">{{ storage.note }}</td>
                <td contenteditable="true" data-field="address">{{ storage.address }}</td>
                <td contenteditable="true" data-field="recentChangeUser">{{ storage.recentChangeUser }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
        <h3>–°–ø–∏—Å–æ–∫ –≤–µ—â–µ–π</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—â—å</button>
        </div>        
        <input type="text" class="form-control" id="searchItems" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –≤–µ—â–∞–º...">
    </div>
    <table class="table table-striped table-bordered" id="editableItemsTable">
        <thead class="table-dark">
            <tr>
                <th></th>
                <th>–§–æ—Ç–æ</th>
                <th onclick="toggleSort(this, 'editableItemsTable', 2)">–ê—Ä—Ç–∏–∫—É–ª <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 3)">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 4)">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 5)">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 6)">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 7)">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ <span></span></th>
                <th>–°–∫–ª–∞–¥</th>
            </tr>
        </thead>
        <tbody>
        {% for item in items %}
            <tr data-doc-id="{{ item.doc_id }}">
                <td>
                    <button class="btn btn-danger btn-sm delete-button"
                    data-doc-id="{{ item.doc_id }}"
                    data-collection="items"
                    data-name="{{ item.name }}">üóë</button>
                </td>


                <td>
                    {% if item.photoUrl %}
                        <img src="{{ item.photoUrl }}" alt="–§–æ—Ç–æ" 
                             class="img-thumbnail clickable-photo" 
                             style="max-height: 100px; max-width: 100px; object-fit: cover;">
                    {% else %}
                        <span class="text-muted">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                    {% endif %}
                </td>
                <td contenteditable="true" data-field="article">{{ item.article }}</td>
                <td contenteditable="true" data-field="name">{{ item.name }}</td>
                <td contenteditable="true" data-field="count">{{ item.count }}</td>
                <td contenteditable="true" data-field="note">{{ item.note }}</td>
                <td contenteditable="true" data-field="recentChangeUser">{{ item.recentChangeUser }}</td>
                <td contenteditable="true" data-field="location">{{ item.location }}</td>
                <td>
                    <select class="form-select storage-selector" data-doc-id="{{ item.doc_id }}">
                        {% for storage in storages %}
                            <option value="{{ storage.id }}"
                                {% if item.storage.id == storage.id %}selected{% endif %}>
                                {{ storage.name }}
                            </option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark">
        <div class="modal-body p-0">
          <img id="modalImage" src="" class="w-100" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ" style="border-radius: 5px;">
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞ -->
  <div class="modal fade" id="addStorageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addStorageForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Å–∫–ª–∞–¥</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="name" class="form-control mb-2" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required>
        <input name="note" class="form-control mb-2" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ">
        <input name="address" class="form-control mb-2" placeholder="–ê–¥—Ä–µ—Å">
        
        <div class="mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
            <label class="form-label fw-bold mb-3 d-block">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ</label>
            <input name="photoUrl" class="form-control mb-2" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
            <div class="text-center text-muted mb-2" style="font-size: 0.9em;">–∏–ª–∏</div>
            <input name="photoFile" class="form-control" type="file" accept="image/*">
        </div>

        <!-- <input name="photoUrl" class="form-control mb-2" placeholder="–§–æ—Ç–æ (URL)">
        <input name="photoFile" class="form-control mb-2" type="file" accept="image/*"> -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ—â–∏ -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addItemForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—â—å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="article" class="form-control mb-2" placeholder="–ê—Ä—Ç–∏–∫—É–ª">
        <input name="name" class="form-control mb-2" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required>
        <input name="count" class="form-control mb-2" type="number" min="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" required>
        <input name="note" class="form-control mb-2" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ">
        <input name="location" class="form-control mb-2" placeholder="–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
        <select name="storage" class="form-select mb-2">
          {% for storage in storages %}
            <option value="{{ storage.id }}">{{ storage.name }}</option>
          {% endfor %}
        </select>

        <div class="mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
            <label class="form-label fw-bold mb-3 d-block">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ</label>
            <input name="photoUrl" class="form-control mb-2" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
            <div class="text-center text-muted mb-2" style="font-size: 0.9em;">–∏–ª–∏</div>
            <input name="photoFile" class="form-control" type="file" accept="image/*">
        </div>
        <!-- <input name="photoUrl" class="form-control mb-2" placeholder="–§–æ—Ç–æ (URL)">
        <input name="photoFile" class="form-control mb-2" type="file" accept="image/*"> -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>



<script>
document.getElementById('addStorageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const res = await fetch('/add_storage', { method: 'POST', body: formData });
    if ((await res.json()).success) {
        location.reload();
        alert("–°–∫–ª–∞–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!");
    }
});

document.getElementById('addItemForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const res = await fetch('/add_item', { method: 'POST', body: formData });
    if ((await res.json()).success) {
        location.reload();
        alert("–í–µ—â—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
    }
});


    let currentSortState = {
    tableId: null,
    columnIndex: null,
    direction: null  // 'asc', 'desc', or null
    };

function toggleSort(header, tableId, columnIndex) {
    const span = header.querySelector('span');

    // –°–±—Ä–æ—Å–∏—Ç—å —Å–∏–º–≤–æ–ª —É –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    document.querySelectorAll(`#${tableId} th span`).forEach(s => s.innerText = '');

    if (currentSortState.tableId === tableId && currentSortState.columnIndex === columnIndex) {
        if (currentSortState.direction === 'asc') {
            currentSortState.direction = 'desc';
            span.innerText = '‚¨áÔ∏è';
        } else if (currentSortState.direction === 'desc') {
            currentSortState.direction = null;
            currentSortState.tableId = null;
            currentSortState.columnIndex = null;
            clearSort(tableId);
            return;
        } else {
            currentSortState.direction = 'asc';
            span.innerText = '‚¨ÜÔ∏è';
        }
    } else {
        currentSortState = {
            tableId,
            columnIndex,
            direction: 'asc'
        };
        span.innerText = '‚¨ÜÔ∏è';
    }

    sortTable(tableId, columnIndex, currentSortState.direction);
}

function sortTable(tableId, columnIndex, direction = 'asc') {
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
        const cellA = a.cells[columnIndex]?.innerText.trim().toLowerCase() || '';
        const cellB = b.cells[columnIndex]?.innerText.trim().toLowerCase() || '';

        if (direction === 'asc') {
            return cellA.localeCompare(cellB, 'ru');
        } else {
            return cellB.localeCompare(cellA, 'ru');
        }
    });

    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

function clearSort(tableId) {
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => 0);  // –ü–æ—Ä—è–¥–æ–∫ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ‚Äî –º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

    document.addEventListener('click', async function(e) {
    if (e.target.classList.contains('delete-button')) {
        const docId = e.target.getAttribute('data-doc-id');
        const collection = e.target.getAttribute('data-collection');
        const name = e.target.getAttribute('data-name') || '—ç–ª–µ–º–µ–Ω—Ç';

        const confirmed = confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "${name}"?`);
        if (confirmed) {
            const response = await fetch('/delete_document', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ doc_id: docId, collection: collection })
            });

            const result = await response.json();
            if (result.success) {
                e.target.closest('tr').remove();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.');
            }
        }
    }
    });

    document.querySelectorAll('.storage-selector').forEach(select => {
    select.addEventListener('change', async (e) => {
        const newStorageId = e.target.value;
        const docId = e.target.getAttribute('data-doc-id');

        await fetch('/update_cell', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                doc_id: docId,
                field: 'storage',
                value: newStorageId
            })
        });
    });
    });

    function setupTableFilter(inputId, tableId) {
        const input = document.getElementById(inputId);
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');

        input.addEventListener('input', () => {
            const filter = input.value.trim().toLowerCase();
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
    const photos = document.querySelectorAll('.clickable-photo');
    const modalImage = document.getElementById('modalImage');
    const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));

    photos.forEach(photo => {
        photo.addEventListener('click', () => {
            modalImage.src = photo.src;
            photoModal.show();
        });
    });
    });

    document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        let originalValue = '';
    
        cell.addEventListener('focus', (e) => {
            originalValue = e.target.innerText.trim();
        });
    
        cell.addEventListener('blur', async (e) => {
            const cell = e.target;
            const newValue = cell.innerText.trim();
            const field = cell.getAttribute('data-field');
            const row = cell.closest('tr');
            const docId = row.getAttribute('data-doc-id');
    
            // NEW: Determine collection name based on table ID
            const table = row.closest('table');
            const collection = table.id === 'editableStoragesTable' ? 'storages' : 'items';

            if (newValue !== originalValue) {
                await fetch('/update_cell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        doc_id: docId,
                        field: field,
                        value: newValue,
                        collection: collection  // <- –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                    })
                });
            }
        });
    
        cell.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                cell.blur();
            }
        });
    });

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
function makeTableResizable(table) {
    const ths = table.querySelectorAll('th');
    ths.forEach(th => {
        const resizer = document.createElement('div');
        resizer.style.width = '5px';
        resizer.style.height = '100%';
        resizer.style.position = 'absolute';
        resizer.style.top = '0';
        resizer.style.right = '0';
        resizer.style.cursor = 'col-resize';
        resizer.style.userSelect = 'none';
        
        th.style.position = 'relative';
        th.appendChild(resizer);

        let startX, startWidth;

        resizer.addEventListener('mousedown', function(e) {
            startX = e.pageX;
            startWidth = parseInt(window.getComputedStyle(th).width, 10);
            document.documentElement.addEventListener('mousemove', onMouseMove);
            document.documentElement.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            const newWidth = startWidth + (e.pageX - startX);
            th.style.width = newWidth + 'px';
        }

        function onMouseUp() {
            document.documentElement.removeEventListener('mousemove', onMouseMove);
            document.documentElement.removeEventListener('mouseup', onMouseUp);
        }
    });
}

    document.addEventListener('DOMContentLoaded', () => {
        setupTableFilter('searchStorages', 'editableStoragesTable');
        setupTableFilter('searchItems', 'editableItemsTable');
    });

    document.addEventListener('DOMContentLoaded', function() {
        const storagesTable = document.getElementById('editableStoragesTable');
        const itemsTable = document.getElementById('editableItemsTable');
        makeTableResizable(storagesTable);
        makeTableResizable(itemsTable);
    });
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
