<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        td[contenteditable="true"]:focus {
            background-color: #e6f7ff;
            outline: 2px solid #66afe9;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>–î–∞–Ω–Ω—ã–µ Inventarium</h1>
            <a href="/export_excel" class="btn btn-success">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
        </div>

    <table class="table table-striped table-bordered" id="editableTable">
        <thead class="table-dark">
            <tr>
                <th>–§–æ—Ç–æ</th>
                <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                <th>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ</th>
                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)</th>
            </tr>
        </thead>
        <tbody>
        {% for item in items %}
            <tr data-doc-id="{{ item.doc_id }}">
                <td>
                    {% if item.photoUrl %}
                        <img src="{{ item.photoUrl }}" alt="–§–æ—Ç–æ" 
                             class="img-thumbnail clickable-photo" 
                             style="max-height: 100px; max-width: 100px; object-fit: cover;">
                    {% else %}
                        <span class="text-muted">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                    {% endif %}
                </td>
                <td contenteditable="true" data-field="article">{{ item.article }}</td>
                <td contenteditable="true" data-field="location">{{ item.location }}</td>
                <td contenteditable="true" data-field="name">{{ item.name }}</td>
                <td contenteditable="true" data-field="note">{{ item.note }}</td>
                <td contenteditable="true" data-field="recentChangeUser">{{ item.recentChangeUser }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark">
        <div class="modal-body p-0">
          <img id="modalImage" src="" class="w-100" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ" style="border-radius: 5px;">
        </div>
      </div>
    </div>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const photos = document.querySelectorAll('.clickable-photo');
    const modalImage = document.getElementById('modalImage');
    const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));

    photos.forEach(photo => {
        photo.addEventListener('click', () => {
            modalImage.src = photo.src;
            photoModal.show();
        });
    });
    });

    document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        let originalValue = '';
    
        cell.addEventListener('focus', (e) => {
            originalValue = e.target.innerText.trim();
        });
    
        cell.addEventListener('blur', async (e) => {
            const cell = e.target;
            const newValue = cell.innerText.trim();
            const field = cell.getAttribute('data-field');
            const row = cell.closest('tr');
            const docId = row.getAttribute('data-doc-id');
    
            if (newValue !== originalValue) {
                console.log("CHANHING DATA")
                
                await fetch('/update_cell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        doc_id: docId,
                        field: field,
                        value: newValue
                    })
                });
            }
        });
    
        cell.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                cell.blur();
            }
        });
    });

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
function makeTableResizable(table) {
    const ths = table.querySelectorAll('th');
    ths.forEach(th => {
        const resizer = document.createElement('div');
        resizer.style.width = '5px';
        resizer.style.height = '100%';
        resizer.style.position = 'absolute';
        resizer.style.top = '0';
        resizer.style.right = '0';
        resizer.style.cursor = 'col-resize';
        resizer.style.userSelect = 'none';
        
        th.style.position = 'relative';
        th.appendChild(resizer);

        let startX, startWidth;

        resizer.addEventListener('mousedown', function(e) {
            startX = e.pageX;
            startWidth = parseInt(window.getComputedStyle(th).width, 10);
            document.documentElement.addEventListener('mousemove', onMouseMove);
            document.documentElement.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            const newWidth = startWidth + (e.pageX - startX);
            th.style.width = newWidth + 'px';
        }

        function onMouseUp() {
            document.documentElement.removeEventListener('mousemove', onMouseMove);
            document.documentElement.removeEventListener('mouseup', onMouseUp);
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('editableTable');
    makeTableResizable(table);
});
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
