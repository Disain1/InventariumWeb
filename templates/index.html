<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        td[contenteditable="true"]:focus {
            background-color: #e6f7ff;
            outline: 2px solid #66afe9;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-5">
    <div class="container-fluid mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>–î–∞–Ω–Ω—ã–µ Inventarium</h1>
            
            <div>
                <form action="/import_excel" method="post" enctype="multipart/form-data" class="d-inline">
                    <input type="file" name="file" accept=".xlsx" class="form-control d-inline w-auto" required>
                    <button type="submit" class="btn btn-primary">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç –∏–∑ Excel</button>
                </form>
    
                <a href="/export_excel" class="btn btn-success">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
            </div>
        </div>

    
    <div class="py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h3>–°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStorageModal">–î–æ–±–∞–≤–∏—Ç—å —Å–∫–ª–∞–¥</button>
        </div>
        <input type="text" class="form-control" id="searchStorages" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥–∞–º...">
    </div>
    <table class="table table-striped table-bordered" id="editableStoragesTable">
        <thead class="table-dark">
            <tr>
                <th></th>
                <th>–§–æ—Ç–æ</th>
                <th onclick="toggleSort(this, 'editableStoragesTable', 2)">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ <span></span></th>
                <th onclick="toggleSort(this, 'editableStoragesTable', 3)">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ <span></span></th>
                <th onclick="toggleSort(this, 'editableStoragesTable', 4)">–ê–¥—Ä–µ—Å <span></span></th>
                <th onclick="toggleSort(this, 'editableStoragesTable', 5)">–õ–æ–≥–∏–Ω <span></span></th>
            </tr>
        </thead>
        <tbody>
        {% for storage in storages %}
            <tr data-doc-id="{{ storage.id }}">
                <td>
                    <button class="btn btn-danger btn-sm delete-button"
                        data-doc-id="{{ storage.id }}"
                        data-collection="storages"
                        data-name="{{ storage.name }}">üóë</button>
                </td>


                <td>
                    {% if storage.photoUrl %}
                        <img src="{{ storage.photoUrl }}" alt="–§–æ—Ç–æ" 
                                class="img-thumbnail clickable-photo" 
                                style="max-height: 100px; max-width: 100px; object-fit: cover;">
                    {% else %}
                        <span class="text-muted">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                    {% endif %}
                </td>
                <td contenteditable="true" data-field="name">{{ storage.name }}</td>
                <td contenteditable="true" data-field="note">{{ storage.note }}</td>
                <td contenteditable="true" data-field="address">{{ storage.address }}</td>
                <td contenteditable="true" data-field="recentChangeUser">{{ storage.recentChangeUser }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
        <h3>–°–ø–∏—Å–æ–∫ –≤–µ—â–µ–π</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—â—å</button>
        </div>        
        <input type="text" class="form-control" id="searchItems" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –≤–µ—â–∞–º...">

        <div class="d-flex justify-content-end align-items-center my-3">
            <label for="storageFilter" class="me-2 mb-0">–§–∏–ª—å—Ç—Ä –ø–æ —Å–∫–ª–∞–¥—É:</label>
            <select id="storageFilter" class="form-select w-auto">
                <option value="all">–í—Å–µ —Å–∫–ª–∞–¥—ã</option>
                {% for storage in storages %}
                    <option value="{{ storage.id }}">{{ storage.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <table class="table table-striped table-bordered" id="editableItemsTable">
        <thead class="table-dark">
            <tr>
                <th></th>
                <th>–§–æ—Ç–æ</th>
                <th onclick="toggleSort(this, 'editableItemsTable', 2)">–ê—Ä—Ç–∏–∫—É–ª <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 3)">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 4)">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 5)">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 6)">–õ–æ–≥–∏–Ω <span></span></th>
                <th onclick="toggleSort(this, 'editableItemsTable', 7)">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ <span></span></th>
                <th style="min-width: 300px;">–°–∫–ª–∞–¥</th>
            </tr>
        </thead>
        <tbody>
        {% for item in items %}
            <tr data-doc-id="{{ item.doc_id }}">
                <td>
                    <button class="btn btn-danger btn-sm delete-button"
                    data-doc-id="{{ item.doc_id }}"
                    data-collection="items"
                    data-name="{{ item.name }}">üóë</button>

                    <button class="btn btn-sm btn-warning me-1 move-button"
                    data-doc-id="{{ item.doc_id }}"
                    data-name="{{ item.name }}"
                    data-count="{{ item.count }}"
                    data-storage-id="{{ item.storage.id }}">üì¶</button>

                    <button class="btn btn-sm btn-secondary me-1 edit-button"
                    data-doc-id="{{ item.doc_id }}"
                    data-article="{{ item.article }}"
                    data-name="{{ item.name }}"
                    data-count="{{ item.count }}"
                    data-note="{{ item.note }}"
                    data-location="{{ item.location }}"
                    data-storage-id="{{ item.storage.id }}"
                    data-photo-url="{{ item.photoUrl }}">‚úèÔ∏è</button>

                </td>


                <td>
                    {% if item.photoUrl %}
                        <img src="{{ item.photoUrl }}" alt="–§–æ—Ç–æ" 
                             class="img-thumbnail clickable-photo" 
                             style="max-height: 100px; max-width: 100px; object-fit: cover;">
                    {% else %}
                        <span class="text-muted">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                    {% endif %}
                </td>
                <td contenteditable="true" data-field="article">{{ item.article }}</td>
                <td contenteditable="true" data-field="name">{{ item.name }}</td>
                <td contenteditable="true" data-field="count">{{ item.count }}</td>
                <td contenteditable="true" data-field="note">{{ item.note }}</td>
                <td contenteditable="true" data-field="recentChangeUser">{{ item.recentChangeUser }}</td>
                <td contenteditable="true" data-field="location">{{ item.location }}</td>
                <td>
                    <select class="form-select storage-selector" data-doc-id="{{ item.doc_id }}">
                        {% for storage in storages %}
                            <option value="{{ storage.id }}"
                                {% if item.storage.id == storage.id %}selected{% endif %}>
                                {{ storage.name }}
                            </option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤–µ—â–∏ -->
<div class="modal fade" id="moveItemModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="moveItemForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–µ—â—å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="doc_id" id="moveDocId">
        <div class="mb-3">
          <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</label>
          <input type="number" class="form-control" name="count" id="moveCount" min="1">
        </div>
        <div class="mb-3">
          <label class="form-label">–ö—É–¥–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</label>
          <select class="form-select" name="destination" id="moveDestination">
            {% for storage in storages %}
              <option value="{{ storage.id }}">{{ storage.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>


<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark">
        <div class="modal-body p-0">
          <img id="modalImage" src="" class="w-100" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ" style="border-radius: 5px;">
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞ -->
  <div class="modal fade" id="addStorageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addStorageForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Å–∫–ª–∞–¥</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="name" class="form-control mb-2" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required>
        <input name="note" class="form-control mb-2" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ">
        <input name="address" class="form-control mb-2" placeholder="–ê–¥—Ä–µ—Å">
        
        <div class="mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
            <label class="form-label fw-bold mb-3 d-block">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ</label>
            <input name="photoUrl" class="form-control mb-2" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
            <div class="text-center text-muted mb-2" style="font-size: 0.9em;">–∏–ª–∏</div>
            <input name="photoFile" class="form-control" type="file" accept="image/*">
        </div>

        <!-- <input name="photoUrl" class="form-control mb-2" placeholder="–§–æ—Ç–æ (URL)">
        <input name="photoFile" class="form-control mb-2" type="file" accept="image/*"> -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>


<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ—â–∏ -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addItemForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—â—å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="name" class="form-control mb-2" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required>
        <input name="article" class="form-control mb-2" placeholder="–ê—Ä—Ç–∏–∫—É–ª">
        <input name="count" class="form-control mb-2" type="number" min="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" required>
        <input name="note" class="form-control mb-2" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ">
        <input name="location" class="form-control mb-2" placeholder="–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
        
        <select name="storage" class="form-select mb-2" required>
        <option value="" disabled selected hidden>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>
            {% for storage in storages %}
                <option value="{{ storage.id }}">{{ storage.name }}</option>
            {% endfor %}
        </select>

        <div class="mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
            <label class="form-label fw-bold mb-3 d-block">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ</label>
            <input name="photoUrl" class="form-control mb-2" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
            <div class="text-center text-muted mb-2" style="font-size: 0.9em;">–∏–ª–∏</div>
            <input name="photoFile" class="form-control" type="file" accept="image/*">
        </div>
        <!-- <input name="photoUrl" class="form-control mb-2" placeholder="–§–æ—Ç–æ (URL)">
        <input name="photoFile" class="form-control mb-2" type="file" accept="image/*"> -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>


<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–µ—â–∏ -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editItemForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ—â—å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="name" class="form-control mb-2" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" required>
        <input name="article" class="form-control mb-2" placeholder="–ê—Ä—Ç–∏–∫—É–ª">
        <input name="count" class="form-control mb-2" type="number" min="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" required>
        <input name="note" class="form-control mb-2" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ">
        <input name="location" class="form-control mb-2" placeholder="–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
        
        <select name="storage" class="form-select mb-2" required>
        <option value="" disabled selected hidden>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>
            {% for storage in storages %}
                <option value="{{ storage.id }}">{{ storage.name }}</option>
            {% endfor %}
        </select>

        <div class="mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
            <label class="form-label fw-bold mb-3 d-block">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ</label>
            <input name="photoUrl" class="form-control mb-2" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ">
            <div class="text-center text-muted mb-2" style="font-size: 0.9em;">–∏–ª–∏</div>
            <input name="photoFile" class="form-control" type="file" accept="image/*">
        </div>
        <!-- <input name="photoUrl" class="form-control mb-2" placeholder="–§–æ—Ç–æ (URL)">
        <input name="photoFile" class="form-control mb-2" type="file" accept="image/*"> -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>



<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—É–∫–∞–º–∏
function setCookie(name, value, days = 30) {
  const d = new Date();
  d.setTime(d.getTime() + days*24*60*60*1000);
  document.cookie = name + "=" + encodeURIComponent(value) + ";path=/;expires=" + d.toUTCString();
}

function getCookie(name) {
  const cookies = document.cookie.split('; ');
  for (let c of cookies) {
    const [key, val] = c.split('=');
    if (key === name) return decodeURIComponent(val);
  }
  return null;
}

document.addEventListener('click', function(e) {
  if (e.target.classList.contains('edit-button')) {
    const btn = e.target;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã
    document.querySelector('#editItemModal input[name="name"]').value = btn.getAttribute('data-name') || '';
    document.querySelector('#editItemModal input[name="article"]').value = btn.getAttribute('data-article') || '';
    document.querySelector('#editItemModal input[name="count"]').value = btn.getAttribute('data-count') || '1';
    document.querySelector('#editItemModal input[name="note"]').value = btn.getAttribute('data-note') || '';
    document.querySelector('#editItemModal input[name="location"]').value = btn.getAttribute('data-location') || '';
    document.querySelector('#editItemModal input[name="photoUrl"]').value = btn.getAttribute('data-photo-url') || '';
    document.querySelector('#editItemModal select[name="storage"]').value = btn.getAttribute('data-storage-id') || '';

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('editItemForm').setAttribute('data-edit-id', btn.getAttribute('data-doc-id'));

    new bootstrap.Modal(document.getElementById('editItemModal')).show();
  }
});

document.getElementById('editItemForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
    const editId = form.getAttribute('data-edit-id');
    formData.append('doc_id', editId);

    const res = await fetch('/update_item', {
        method: 'POST',
        body: formData
    });

    const result = await res.json();
    if (result.success) {
        alert('–í–µ—â—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        location.reload();
    } else {
        alert(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.');
    }
});

document.addEventListener('click', (e) => {
  if (e.target.classList.contains('move-button')) {
    const docId = e.target.getAttribute('data-doc-id');
    const name = e.target.getAttribute('data-name');
    const count = e.target.getAttribute('data-count');
    const currentStorage = e.target.getAttribute('data-storage-id');

    document.getElementById('moveDocId').value = docId;
    document.getElementById('moveCount').value = count;
    document.getElementById('moveCount').setAttribute('max', count);

    const destination = document.getElementById('moveDestination');
    [...destination.options].forEach(option => {
      option.disabled = option.value === currentStorage;
    });

    new bootstrap.Modal(document.getElementById('moveItemModal')).show();
  }
});

document.getElementById('moveItemForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const docId = form.moveDocId.value;
  const count = parseInt(form.moveCount.value);
  const destination = form.moveDestination.value;

  const response = await fetch('/move_item', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ doc_id: docId, count, destination })
  });

  const result = await response.json();
  if (result.success) {
    alert(result.message || '–í–µ—â—å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞');
    location.reload();
  } else {
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏');
  }
});



document.getElementById('addStorageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const res = await fetch('/add_storage', { method: 'POST', body: formData });
    if ((await res.json()).success) {
        location.reload();
        alert("–°–∫–ª–∞–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!");
    }
});

document.getElementById('addItemForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const res = await fetch('/add_item', { method: 'POST', body: formData });
    if ((await res.json()).success) {
        location.reload();
        alert("–í–µ—â—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
    }
});


    let currentSortState = {
    tableId: null,
    columnIndex: null,
    direction: null  // 'asc', 'desc', or null
    };

function toggleSort(header, tableId, columnIndex) {
    const span = header.querySelector('span');

    // –°–±—Ä–æ—Å–∏—Ç—å —Å–∏–º–≤–æ–ª —É –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    document.querySelectorAll(`#${tableId} th span`).forEach(s => s.innerText = '');

    if (currentSortState.tableId === tableId && currentSortState.columnIndex === columnIndex) {
        if (currentSortState.direction === 'asc') {
            currentSortState.direction = 'desc';
            span.innerText = '‚¨áÔ∏è';
        } else if (currentSortState.direction === 'desc') {
            currentSortState.direction = null;
            currentSortState.tableId = null;
            currentSortState.columnIndex = null;
            clearSort(tableId);
            return;
        } else {
            currentSortState.direction = 'asc';
            span.innerText = '‚¨ÜÔ∏è';
        }
    } else {
        currentSortState = {
            tableId,
            columnIndex,
            direction: 'asc'
        };
        span.innerText = '‚¨ÜÔ∏è';
    }

    sortTable(tableId, columnIndex, currentSortState.direction);
}

function sortTable(tableId, columnIndex, direction = 'asc') {
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.sort((a, b) => {
        const cellA = a.cells[columnIndex]?.innerText.trim().toLowerCase() || '';
        const cellB = b.cells[columnIndex]?.innerText.trim().toLowerCase() || '';

        if (direction === 'asc') {
            return cellA.localeCompare(cellB, 'ru');
        } else {
            return cellB.localeCompare(cellA, 'ru');
        }
    });

    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

function clearSort(tableId) {
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => 0);  // –ü–æ—Ä—è–¥–æ–∫ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ‚Äî –º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

    document.addEventListener('click', async function(e) {
    if (e.target.classList.contains('delete-button')) {
        const docId = e.target.getAttribute('data-doc-id');
        const collection = e.target.getAttribute('data-collection');
        const name = e.target.getAttribute('data-name') || '—ç–ª–µ–º–µ–Ω—Ç';

        const confirmed = confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "${name}"?`);

        if (collection == "storages") {
            const checkRes = await fetch(`/check_storage_items_count/${docId}`);
            const checkData = await checkRes.json();

            if (!checkRes.ok) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–∫–ª–∞–¥–∞.');
                return;
            }

            if (checkData.count > 0) {
                confirmMessage = `–ù–∞ —Å–∫–ª–∞–¥–µ "${name}" —Ö—Ä–∞–Ω—è—Ç—Å—è ${checkData.count} –ø–æ–∑–∏—Ü–∏–π.\n–ü—Ä–æ–¥–æ–ª–∂–∞—è, –æ–Ω–∏ –±—É–¥—É—Ç —Ç–∞–∫–∂–µ —É–¥–∞–ª–µ–Ω—ã!\n\n–£–¥–∞–ª–∏—Ç—å —Å–∫–ª–∞–¥?`;
                storage_confirmed = confirm(confirmMessage);
                if (!storage_confirmed) { return; }
            }
        }

        if (confirmed) {
            const response = await fetch('/delete_document', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ doc_id: docId, collection: collection })
            });

            const result = await response.json();
            if (result.success) {
                e.target.closest('tr').remove();
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.');
            }
        }
    }
    });

    document.querySelectorAll('.storage-selector').forEach(select => {
    select.addEventListener('change', async (e) => {
        const newStorageId = e.target.value;
        const docId = e.target.getAttribute('data-doc-id');

        const response = await fetch('/update_cell', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                doc_id: docId,
                field: 'storage',
                value: newStorageId
            })
        });

        const result = await response.json();

        if (result.merged) {
            alert("–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Å–∫–ª–∞–¥–µ —É–∂–µ –µ—Å—Ç—å –≤–µ—â—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º.\n–û–Ω–∏ –±—ã–ª–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã");
            location.reload();
        } else if (result.moved) {
            alert("–í–µ—â—å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –Ω–∞ –¥—Ä—É–≥–æ–π —Å–∫–ª–∞–¥.");
        } else if (!result.success) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏.");
        }
    });
});

    function setupTableFilter(inputId, tableId) {
        const input = document.getElementById(inputId);
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');

        

        input.addEventListener('input', () => {
            const filter = input.value.trim().toLowerCase();
            const rows = tbody.querySelectorAll('tr');
            
            setCookie('searchItems', filter);

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
    const photos = document.querySelectorAll('.clickable-photo');
    const modalImage = document.getElementById('modalImage');
    const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));

    photos.forEach(photo => {
        photo.addEventListener('click', () => {
            modalImage.src = photo.src;
            photoModal.show();
        });
    });
    });

    document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        let originalValue = '';
    
        cell.addEventListener('focus', (e) => {
            originalValue = e.target.innerText.trim();
        });
    
        cell.addEventListener('blur', async (e) => {
            const cell = e.target;
            const newValue = cell.innerText.trim();
            const field = cell.getAttribute('data-field');
            const row = cell.closest('tr');
            const docId = row.getAttribute('data-doc-id');
    
            // NEW: Determine collection name based on table ID
            const table = row.closest('table');
            const collection = table.id === 'editableStoragesTable' ? 'storages' : 'items';

            if (newValue !== originalValue) {
                await fetch('/update_cell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        doc_id: docId,
                        field: field,
                        value: newValue,
                        collection: collection  // <- –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                    })
                });
            }
        });
    
        cell.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                cell.blur();
            }
        });
    });

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
function makeTableResizable(table) {
    const ths = table.querySelectorAll('th');
    ths.forEach(th => {
        const resizer = document.createElement('div');
        resizer.style.width = '5px';
        resizer.style.height = '100%';
        resizer.style.position = 'absolute';
        resizer.style.top = '0';
        resizer.style.right = '0';
        resizer.style.cursor = 'col-resize';
        resizer.style.userSelect = 'none';
        
        th.style.position = 'relative';
        th.appendChild(resizer);

        let startX, startWidth;

        resizer.addEventListener('mousedown', function(e) {
            startX = e.pageX;
            startWidth = parseInt(window.getComputedStyle(th).width, 10);
            document.documentElement.addEventListener('mousemove', onMouseMove);
            document.documentElement.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            const newWidth = startWidth + (e.pageX - startX);
            th.style.width = newWidth + 'px';
        }

        function onMouseUp() {
            document.documentElement.removeEventListener('mousemove', onMouseMove);
            document.documentElement.removeEventListener('mouseup', onMouseUp);
        }
    });
}

    document.addEventListener('DOMContentLoaded', () => {
        setupTableFilter('searchStorages', 'editableStoragesTable');
        setupTableFilter('searchItems', 'editableItemsTable');
    });

    document.addEventListener('DOMContentLoaded', function() {
        const storagesTable = document.getElementById('editableStoragesTable');
        const itemsTable = document.getElementById('editableItemsTable');
        makeTableResizable(storagesTable);
        makeTableResizable(itemsTable);
    });

    document.addEventListener('DOMContentLoaded', function () {
    const filterSelect = document.getElementById('storageFilter');
    const itemsTable = document.getElementById('editableItemsTable');
    const rows = itemsTable.querySelectorAll('tbody tr');

    filterSelect.addEventListener('change', () => {
        const selectedId = filterSelect.value;
        
        setCookie('storageFilter', selectedId);
        rows.forEach(row => {
            const selectElement = row.querySelector('.storage-selector');
            const itemStorageId = selectElement?.value;
            row.style.display = (selectedId === 'all' || itemStorageId === selectedId) ? '' : 'none';
        });
    });
});

document.addEventListener('DOMContentLoaded', () => {
    const filterSelect = document.getElementById('storageFilter');
    const searchInput = document.getElementById('searchItems');

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Å–∫–ª–∞–¥–∞
  const savedStorageFilter = getCookie('storageFilter');
  if (savedStorageFilter) {
    filterSelect.value = savedStorageFilter;
    filterSelect.dispatchEvent(new Event('change'));
  }

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∏—Å–∫
  const savedSearchItems = getCookie('searchItems');
  if (savedSearchItems) {
    searchInput.value = savedSearchItems;
    searchInput.dispatchEvent(new Event('input'));
  }
});
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
