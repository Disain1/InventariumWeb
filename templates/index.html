<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        td[contenteditable="true"]:focus {
            background-color: #e6f7ff;
            outline: 2px solid #66afe9;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-5">
    <div class="container-fluid mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>–î–∞–Ω–Ω—ã–µ Inventarium</h1>
            
            <div>
                <form action="/import_excel" method="post" enctype="multipart/form-data" class="d-inline">
                    <input type="file" name="file" accept=".xlsx" class="form-control d-inline w-auto" required>
                    <button type="submit" class="btn btn-primary">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç –∏–∑ Excel</button>
                </form>
    
                <a href="/export_excel" class="btn btn-success">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
            </div>
        </div>

    <div class="mb-3">
        <input type="text" class="form-control" id="searchStorages" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥–∞–º...">
    </div>
    <table class="table table-striped table-bordered" id="editableStoragesTable">
        <thead class="table-dark">
            <tr>
                <th>–§–æ—Ç–æ</th>
                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                <th>–ê–¥—Ä–µ—Å</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)</th>
            </tr>
        </thead>
        <tbody>
        {% for storage in storages %}
            <tr data-doc-id="{{ storage.id }}">
                <td>
                    {% if storage.photoUrl %}
                        <img src="{{ storage.photoUrl }}" alt="–§–æ—Ç–æ" 
                                class="img-thumbnail clickable-photo" 
                                style="max-height: 100px; max-width: 100px; object-fit: cover;">
                    {% else %}
                        <span class="text-muted">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                    {% endif %}
                </td>
                <td contenteditable="true" data-field="name">{{ storage.name }}</td>
                <td contenteditable="true" data-field="note">{{ storage.note }}</td>
                <td contenteditable="true" data-field="address">{{ storage.address }}</td>
                <td contenteditable="true" data-field="recentChangeUser">{{ storage.recentChangeUser }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="mb-3">
        <input type="text" class="form-control" id="searchItems" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –≤–µ—â–∞–º...">
    </div>
    <table class="table table-striped table-bordered" id="editableItemsTable">
        <thead class="table-dark">
            <tr>
                <th>–§–æ—Ç–æ</th>
                <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)</th>
                <th>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ</th>
                <th>–°–∫–ª–∞–¥</th>
            </tr>
        </thead>
        <tbody>
        {% for item in items %}
            <tr data-doc-id="{{ item.doc_id }}">
                <td>
                    {% if item.photoUrl %}
                        <img src="{{ item.photoUrl }}" alt="–§–æ—Ç–æ" 
                             class="img-thumbnail clickable-photo" 
                             style="max-height: 100px; max-width: 100px; object-fit: cover;">
                    {% else %}
                        <span class="text-muted">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                    {% endif %}
                </td>
                <td contenteditable="true" data-field="article">{{ item.article }}</td>
                <td contenteditable="true" data-field="name">{{ item.name }}</td>
                <td contenteditable="true" data-field="count">{{ item.count }}</td>
                <td contenteditable="true" data-field="note">{{ item.note }}</td>
                <td contenteditable="true" data-field="recentChangeUser">{{ item.recentChangeUser }}</td>
                <td contenteditable="true" data-field="location">{{ item.location }}</td>
                <td>
                    <select class="form-select storage-selector" data-doc-id="{{ item.doc_id }}">
                        {% for storage in storages %}
                            <option value="{{ storage.id }}"
                                {% if item.storage.id == storage.id %}selected{% endif %}>
                                {{ storage.name }}
                            </option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark">
        <div class="modal-body p-0">
          <img id="modalImage" src="" class="w-100" alt="–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ" style="border-radius: 5px;">
        </div>
      </div>
    </div>
  </div>

<script>
    document.querySelectorAll('.storage-selector').forEach(select => {
    select.addEventListener('change', async (e) => {
        const newStorageId = e.target.value;
        const docId = e.target.getAttribute('data-doc-id');

        await fetch('/update_cell', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                doc_id: docId,
                field: 'storage',
                value: newStorageId
            })
        });
    });
    });

    function setupTableFilter(inputId, tableId) {
        const input = document.getElementById(inputId);
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');

        input.addEventListener('input', () => {
            const filter = input.value.trim().toLowerCase();
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
    const photos = document.querySelectorAll('.clickable-photo');
    const modalImage = document.getElementById('modalImage');
    const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));

    photos.forEach(photo => {
        photo.addEventListener('click', () => {
            modalImage.src = photo.src;
            photoModal.show();
        });
    });
    });

    document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        let originalValue = '';
    
        cell.addEventListener('focus', (e) => {
            originalValue = e.target.innerText.trim();
        });
    
        cell.addEventListener('blur', async (e) => {
            const cell = e.target;
            const newValue = cell.innerText.trim();
            const field = cell.getAttribute('data-field');
            const row = cell.closest('tr');
            const docId = row.getAttribute('data-doc-id');
    
            // NEW: Determine collection name based on table ID
            const table = row.closest('table');
            const collection = table.id === 'editableStoragesTable' ? 'storages' : 'items';

            if (newValue !== originalValue) {
                await fetch('/update_cell', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        doc_id: docId,
                        field: field,
                        value: newValue,
                        collection: collection  // <- –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                    })
                });
            }
        });
    
        cell.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                cell.blur();
            }
        });
    });

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ—Å–∞–π–∑–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
function makeTableResizable(table) {
    const ths = table.querySelectorAll('th');
    ths.forEach(th => {
        const resizer = document.createElement('div');
        resizer.style.width = '5px';
        resizer.style.height = '100%';
        resizer.style.position = 'absolute';
        resizer.style.top = '0';
        resizer.style.right = '0';
        resizer.style.cursor = 'col-resize';
        resizer.style.userSelect = 'none';
        
        th.style.position = 'relative';
        th.appendChild(resizer);

        let startX, startWidth;

        resizer.addEventListener('mousedown', function(e) {
            startX = e.pageX;
            startWidth = parseInt(window.getComputedStyle(th).width, 10);
            document.documentElement.addEventListener('mousemove', onMouseMove);
            document.documentElement.addEventListener('mouseup', onMouseUp);
        });

        function onMouseMove(e) {
            const newWidth = startWidth + (e.pageX - startX);
            th.style.width = newWidth + 'px';
        }

        function onMouseUp() {
            document.documentElement.removeEventListener('mousemove', onMouseMove);
            document.documentElement.removeEventListener('mouseup', onMouseUp);
        }
    });
}

    document.addEventListener('DOMContentLoaded', () => {
        setupTableFilter('searchStorages', 'editableStoragesTable');
        setupTableFilter('searchItems', 'editableItemsTable');
    });

    document.addEventListener('DOMContentLoaded', function() {
        const storagesTable = document.getElementById('editableStoragesTable');
        const itemsTable = document.getElementById('editableItemsTable');
        makeTableResizable(storagesTable);
        makeTableResizable(itemsTable);
    });
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
